name: Auto Kanban (PR)

on:
  pull_request:
    types: [opened, reopened, closed]

jobs:
  pr-kanban:
    runs-on: ubuntu-latest
    steps:
      - name: Set token
        id: token
        run: |
          if [ -n "${{ secrets.PROJECT_TOKEN }}" ]; then echo "TOKEN=${{ secrets.PROJECT_TOKEN }}" >> $GITHUB_OUTPUT; else echo "TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT; fi
      - name: Determine issue number from branch
        id: issue
        run: |
          BRANCH=${{ github.head_ref }}
          # expect patterns like feat/10-desc or fix/12-desc
          ISS=$(echo "$BRANCH" | sed -E 's#^.*/([0-9]+).*#\1#')
          echo "ISSUE=$ISS" >> $GITHUB_OUTPUT
      - name: Move issue on PR events
        env:
          TOKEN: ${{ steps.token.outputs.TOKEN }}
          REPO: ${{ github.repository }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_STATE: ${{ github.event.action }}
          ISSUE_NUM: ${{ steps.issue.outputs.ISSUE }}
        run: |
          if [ -z "$ISSUE_NUM" ] || [ "$ISSUE_NUM" = "feat" ]; then echo "No issue number found in branch; skipping"; exit 0; fi
          echo "Handling PR action=$PR_STATE for issue #$ISSUE_NUM"
          if [ "$PR_STATE" = "opened" ] || [ "$PR_STATE" = "reopened" ]; then
            # label issue as in-review
            gh issue edit $ISSUE_NUM --add-label status/review --repo $REPO --cache 2>/dev/null || gh api repos/$REPO/issues/$ISSUE_NUM -X PATCH -F labels='["status/review"]' -H "Authorization: token $TOKEN"
            gh issue comment $ISSUE_NUM --body "PR opened: $PR_URL" --repo $REPO || true
          elif [ "$PR_STATE" = "closed" ]; then
            if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
              gh issue edit $ISSUE_NUM --add-label status/done --repo $REPO --cache 2>/dev/null || gh api repos/$REPO/issues/$ISSUE_NUM -X PATCH -F labels='["status/done"]' -H "Authorization: token $TOKEN"
            fi
          fi
