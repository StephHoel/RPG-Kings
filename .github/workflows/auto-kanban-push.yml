name: Auto Kanban (Push)

on:
  push:
    branches: ['**']

jobs:
  push-kanban:
    runs-on: ubuntu-latest
    steps:
      - name: Set token
        id: token
        run: |
          if [ -n "${{ secrets.PROJECT_TOKEN }}" ]; then echo "TOKEN=${{ secrets.PROJECT_TOKEN }}" >> $GITHUB_OUTPUT; else echo "TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT; fi

      - name: Export GH token for gh CLI
        run: echo "GH_TOKEN=${{ steps.token.outputs.TOKEN }}" >> $GITHUB_ENV

      - name: Determine branch and issue number
        id: issue
        run: |
          BRANCH=$(echo "${{ github.ref }}" | sed -E 's#refs/heads/##')
          # expect patterns like feat/10-desc or fix/12-desc
          ISS=$(echo "$BRANCH" | sed -E 's#^.*/([0-9]+).*#\1#')
          echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT
          echo "ISSUE=$ISS" >> $GITHUB_OUTPUT

      - name: Update issue label if needed
        env:
          REPO: ${{ github.repository }}
          ISSUE_NUM: ${{ steps.issue.outputs.ISSUE }}
          BRANCH: ${{ steps.issue.outputs.BRANCH }}
          TOKEN: ${{ steps.token.outputs.TOKEN }}
        run: |
          # If branch doesn't follow expected pattern (no issue number), do nothing
          if [ -z "$ISSUE_NUM" ] || [ "$ISSUE_NUM" = "feat" ]; then
            echo "No issue number found in branch '$BRANCH'; skipping"; || true
          fi
          echo "Processing issue #$ISSUE_NUM for branch $BRANCH"
          # get current labels
          EXISTING_LABELS_JSON=$(gh issue view $ISSUE_NUM --repo $REPO --json labels --jq '.labels[].name' 2>/dev/null)
          HAS_BACKLOG=false
          if [ -n "$EXISTING_LABELS_JSON" ]; then
            for L in $EXISTING_LABELS_JSON; do
              if [ "$L" = "status/backlog" ]; then
                HAS_BACKLOG=true
              fi
            done
          fi
          if [ "$HAS_BACKLOG" = "true" ]; then
            # add in-progress
            gh issue edit $ISSUE_NUM --add-label status/in-progress --repo $REPO --cache 2>/dev/null || gh api repos/$REPO/issues/$ISSUE_NUM -X PATCH -f labels[]="status/in-progress" -H "Authorization: token $TOKEN"
            gh issue comment $ISSUE_NUM --body "Branch pushed: ${BRANCH} (commit: https://github.com/$REPO/commit/$GITHUB_SHA) â€” moved from backlog to in-progress" --repo $REPO
            # best-effort ProjectV2 sync (optional)
            PROJECT_TOKEN=${{ secrets.PROJECT_TOKEN }} node ./scripts/sync-projectv2.mjs --owner ${{ github.repository_owner }} --repo ${{ github.event.repository.name }} --project-number 1 --issue $ISSUE_NUM --status "In progress"
          else
            echo "Issue #$ISSUE_NUM does not have status/backlog; no action taken."
          fi
