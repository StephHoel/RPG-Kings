name: Auto Kanban (Label)

on:
  issues:
    types: [labeled]

jobs:
  label-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Choose token
        id: token
        run: |
          if [ -n "${{ secrets.PROJECT_TOKEN }}" ]; then echo "TOKEN=${{ secrets.PROJECT_TOKEN }}" >> $GITHUB_OUTPUT; else echo "TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT; fi

      - name: Login gh CLI
        run: echo "${{ steps.token.outputs.TOKEN }}" | gh auth login --with-token

      - name: Prevent event loop (check token owner)
        id: check
        env:
          TOKEN: ${{ steps.token.outputs.TOKEN }}
          EVENT_SENDER: ${{ github.event.sender.login }}
        run: |
          echo "${{ steps.token.outputs.TOKEN }}" | gh auth login --with-token
          # obter o login do proprietário do token (necessita gh autenticado)
          GH_USER=$(gh api user --jq .login 2>/dev/null || echo '')
          echo "Proprietário do token: $GH_USER"
          echo "Autor do evento: $EVENT_SENDER"
          # exportar o login do bot para comparação no passo de aplicação
          echo "bot=$GH_USER" >> $GITHUB_OUTPUT
          if [ "$GH_USER" = "$EVENT_SENDER" ]; then
            echo "O dono do token é o mesmo que o autor do evento; esta execução foi iniciada pelo bot."
          fi

      - name: Map label to status
        env:
          REPO: ${{ github.repository }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          LABEL: ${{ github.event.label.name }}
          TOKEN: ${{ steps.token.outputs.TOKEN }}
          COMMENT_ON_RESULT: 'true'
        run: |
          echo "GH_TOKEN=${{ steps.token.outputs.TOKEN }}" >> $GITHUB_ENV
          echo "GITHUB_TOKEN=${{ steps.token.outputs.TOKEN }}" >> $GITHUB_ENV
          # garantir que o gh use o mesmo token para que operações de label saiam do mesmo principal
          gh auth status
          
        
      - name: Map label to status (apply)
        if: ${{ github.event.sender.login != steps.check.outputs.bot }}
        env:
          REPO: ${{ github.repository }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          LABEL: ${{ github.event.label.name }}
          TOKEN: ${{ steps.token.outputs.TOKEN }}
          COMMENT_ON_RESULT: 'true'
          PROJECT_ID: PVT_kwHOAzdNtc4BIwXp
          STATUS_FIELD_ID: PVTSSF_lAHOAzdNtc4BIwXpzg5H3q8
          OPTION_BACKLOG: f75ad846
          OPTION_READY: 61e4505c
          OPTION_IN_PROGRESS: 47fc9ee4
          OPTION_IN_REVIEW: df73e18b
          OPTION_DONE: 98236657
        run: |
          echo "Issue #$ISSUE_NUM: rótulo acionado: $LABEL"
          # não mude nada se a issue já tiver o rótulo alvo
          CURRENT_LABELS=$(gh issue view $ISSUE_NUM --repo $REPO --json labels --jq '.labels[].name' 2>/dev/null || echo '')
          for L in $CURRENT_LABELS; do
            if [ "$L" = "$LABEL" ]; then
                echo "Rótulo alvo $LABEL já presente; nada a fazer."; exit 0
            fi
          done
          echo "Rótulos atuais não contêm $LABEL; procedendo para mapear e aplicar o status."
          case "$LABEL" in
            status/backlog)
              TARGET=status/backlog ;;
            status/ready)
              TARGET=status/ready ;;
            status/in-progress)
              TARGET=status/in-progress ;;
            status/in-review | status/review)
              TARGET=status/review ;;
            status/done)
              TARGET=status/done ;;
            *)
              echo "Rótulo não mapeado para status; pulando"; exit 0 ;;
          esac
          # Garantir que exista apenas um rótulo status/*: remover os existentes e adicionar o TARGET
          EXISTING_LABELS_JSON=$(gh issue view $ISSUE_NUM --repo $REPO --json labels --jq '.labels[].name' 2>/dev/null)
          if [ -n "$EXISTING_LABELS_JSON" ]; then
            # remove any label starting with status/
            for L in $EXISTING_LABELS_JSON; do
              case "$L" in
                status/*)
                  gh issue edit $ISSUE_NUM --remove-label "$L" --repo $REPO ;;
                *) ;;
              esac
            done
          fi
          # add the new status label
          gh issue edit $ISSUE_NUM --add-label $TARGET --repo $REPO
          # Try to sync ProjectV2 status (best-effort)
          # If we have an OPTION_* env that matches the target, pass its value (the option id).
          case "${TARGET#status/}" in
            backlog) STATUS_OPTION="$OPTION_BACKLOG" ;; 
            ready) STATUS_OPTION="$OPTION_READY" ;; 
            in-progress) STATUS_OPTION="$OPTION_IN_PROGRESS" ;; 
            in-review) STATUS_OPTION="$OPTION_IN_REVIEW" ;; 
            review) STATUS_OPTION="$OPTION_IN_REVIEW" ;; 
            done) STATUS_OPTION="$OPTION_DONE" ;; 
            *) echo "Rótulo não esperado" && exit 0 ;; 
          esac
          PROJECT_TOKEN=${{ secrets.PROJECT_TOKEN }} node ./scripts/sync-projectv2.mjs --owner ${{ github.repository_owner }} --repo ${{ github.event.repository.name }} --project-number 1 --issue $ISSUE_NUM --status "$STATUS_OPTION"
