name: Kanban - Label Sync

on:
  issues:
    types: [labeled, unlabeled]

permissions:
  issues: write
  contents: read

env:
  PROJECT_ID: PVT_kwHOAzdNtc4BIwXp
  STATUS_FIELD_ID: PVTSSF_lAHOAzdNtc4BIwXpzg5H3q8
  OPTION_BACKLOG: f75ad846
  OPTION_READY: 61e4505c
  OPTION_IN_PROGRESS: 47fc9ee4
  OPTION_IN_REVIEW: df73e18b
  OPTION_DONE: 98236657

jobs:
  sync-status:
    runs-on: ubuntu-latest
    steps:
      - name: Sync issue label to project Status
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const projectId = process.env.PROJECT_ID
            const statusFieldId = process.env.STATUS_FIELD_ID
            const mapping = {
              'status/backlog': process.env.OPTION_BACKLOG,
              'status/ready': process.env.OPTION_READY,
              'status/in progress': process.env.OPTION_IN_PROGRESS,
              'status/in review': process.env.OPTION_IN_REVIEW,
              'status/done': process.env.OPTION_DONE,
            }

            const issue = context.payload.issue
            if (!issue) return

            // Determine matching label (favor last labeled)
            const labels = issue.labels.map(l => l.name.toLowerCase())
            let found = null
            for (const l of labels) {
              if (mapping[l]) { found = mapping[l]; break }
            }
            if (!found) return

            // Ensure project item exists
            const contentId = issue.node_id
            const addRes = await github.graphql(`
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemByContent(input: {projectId: $projectId, contentId: $contentId}) {
                  item { id }
                }
              }
            `, { projectId, contentId })

            const itemId = addRes.addProjectV2ItemByContent.item.id

            // Update field
            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {projectId: $projectId, itemId: $itemId, fieldId: $fieldId, value: {singleSelectOptionId: $optionId}}) {
                  projectV2Item {
                    id
                  }
                }
              }
            `, { projectId, itemId, fieldId: statusFieldId, optionId: found })

            core.info(`Set project item ${itemId} status to ${found}`)
